---
title: "Build Standard Database"
output:
  html_document:
    theme: cosmo
    toc: yes
editor_options: 
  chunk_output_type: console
---

## Administration

#### Purpose
Procedure to translate any number of on-board survey data sets into a single 
dataset with common variables and common responses.  This is a work-in-progress 
production version of the procedures.  See `../mini-example` and 
`../small-example` for working proto-types.  In this script, we put in place 
procedures to process surveys into a standard database.  See 
`Extract Variables from Legacy Surveys.Rmd` for procedures to extract 
variables from legacy surveys (i.e., those with SAS summary scripts).

To use these scripts, analysts must intervene at specific locations. To assist
in this work, we've added header tags in the markdown document to show where
interventions are necessary. Over time, it may be possible to automate these 
interventions.

#### Issues
1. Code remains coarse in a few places; tread carefully when adding an operator

## Overhead

#### Libraries
```{r overhead}
list_of_packages <- c(
  "tidyverse",
  "knitr"
  )

new_packages <- list_of_packages[!(list_of_packages %in% installed.packages()[,"Package"])]

if(length(new_packages)) install.packages(new_packages)

for (p in list_of_packages){
  library(p, character.only = TRUE)
}
```

#### Knitr and global config
```{r config, include=FALSE}
knitr::opts_chunk$set(cache = FALSE, error = TRUE)

options(stringsAsFactors = FALSE)
```

# _User Intervention #01_
The code uses r-user-name-specific relative directories. Add your name and your
relative (to this directory) path to the `Data and Reports` directory to the two
vectors in the below code block. Run `Sys.getenv('USERNAME')` to determine your R
user name.

#### Remote file names
```{r user_lookup, echo = FALSE}
user_list <- data.frame(
  user = c("helseljw", 
           "USDO225024"), 
  path = c("../../Data and Reports/", 
           "~/GitHub/onboard-surveys/Data and Reports/")
)
```

# _User Intervention #02_ 
When adding a new operator, the user must: add the path to the survey data in 
the code block below, e.g., `f_bart_survey_path`
```{r file-names}
dir_path <- user_list %>%
  filter(user == Sys.getenv("USERNAME")) %>%
  .$path

f_spatial_to_be_geocoded_path <- paste0(dir_path, 
  "_geocoding Standardized/spatial_places_to_be_geocoded.csv")

f_board_to_be_geocoded_path <- paste0(dir_path, 
  "_geocoding Standardized/boarding_places_to_be_geocoded.csv")

f_alight_to_be_geocoded_path <- paste0(dir_path, 
  "_geocoding Standardized/alighting_places_to_be_geocoded.csv")

f_spatial_geocoded_path <- paste0(dir_path, 
  "_geocoding Standardized/spatial_places_geocoded.csv")

f_transit_geocoded_path <- paste0(dir_path, 
  "_geocoding Standardized/boarding_alighting_places_geocoded.csv")

f_caltrain_survey_path <- paste0(dir_path, 
  "Caltrain/As CSV/Caltrain_Final_Submitted_1_5_2015_TYPE_WEIGHT_DATE NO POUND OR SINGLE QUOTE.csv")

f_napa_survey_path <- paste0(dir_path, 
  "Napa Vine/As CSV/Napa Vine Transit OD Survey Data_Dec10_Submitted_toAOK_with_transforms NO POUND OR SINGLE QUOTE.csv")

f_bart_survey_path <- paste0(dir_path, 
  "BART/As CSV/BART_Final_Database_Mar18_SUBMITTED_with_station_xy_with_first_board_last_alight NO POUND OR SINGLE QUOTE.csv")

f_muni_survey_path <- paste0(dir_path, 
  "Muni/As CSV/MUNI_DRAFTFINAL_20171114 NO POUND OR SINGLE QUOTE.csv")

f_vta_survey_path <- paste0(dir_path, 
  "VTA/As CSV/VTA_DRAFTFINAL_20171114 NO POUND OR SINGLE QUOTE.csv")

<<<<<<< HEAD
f_actransit_survey_path <- paste0(dir_path,
  "AC Transit/2018/OD_20180703_ACTransit_DraftFinal_Income_Imputation (EasyPassRecode)_ADD_STANDARD_VARS.csv")

f_output_rdata_path <- paste0(dir_path, 
  "_data Standardized/survey_standard.RDS")

f_output_csv_path <- paste0(dir_path, 
  "_data Standardized/survey_standard.csv")

f_ancillary_output_rdata_path <- paste0(dir_path, 
  "_data Standardized/ancillary_variables.RDS")

f_ancillary_output_csv_path <- paste0(dir_path, 
  "_data Standardized/ancillary_variables.csv")

f_output_decom_rdata_path <- paste0(dir_path, 
  "_data Standardized/decomposition/survey_decomposition.RDS")

f_output_decom_csv_path <- paste0(dir_path, 
  "_data Standardized/decomposition/survey_decomposition.csv")
```

# _User Intervention #03_
When adding a new operator, the user must update the dictionary files that translate
the survey coding to the standard coding. Edits to the dictionary can be made in
the Excel file `Dictionary for Standard Database.xlsx`. The Excel file needs to 
be exported to `csv`; the code reads in the CSV file. The existing entries in the
dictionary *should* explicate the expected task. 

=======
f_output_rdata_path <- paste0(dir_path, 
  "_data Standardized/survey_standard.RDS")

f_output_csv_path <- paste0(dir_path, 
  "_data Standardized/survey_standard.csv")

f_ancillary_output_rdata_path <- paste0(dir_path, 
  "_data Standardized/ancillary_variables.RDS")

f_ancillary_output_csv_path <- paste0(dir_path, 
  "_data Standardized/ancillary_variables.csv")

f_output_decom_rdata_path <- paste0(dir_path, 
  "_data Standardized/decomposition/survey_decomposition.RDS")

f_output_decom_csv_path <- paste0(dir_path, 
  "_data Standardized/decomposition/survey_decomposition.csv")
```

# _User Intervention #03_
When adding a new operator, the user must update the dictionary files that translate
the survey coding to the standard coding. Edits to the dictionary can be made in
the Excel file `Dictionary for Standard Database.xlsx`. The Excel file needs to 
be exported to `csv`; the code reads in the CSV file. The existing entries in the
dictionary *should* explicate the expected task. 

>>>>>>> refactor_survey
## Prepare Dictionaries
```{r prepare-dictionary}
dictionary_all <- read.csv('Dictionary for Standard Database.csv', 
                           header = TRUE) %>%
  rename_all(tolower)

# Prepare separate dictionaries for categorical and non-categorical variables
dictionary_non <- dictionary_all %>%
  filter(generic_response == 'NONCATEGORICAL') %>%
  select(operator, survey_variable, generic_variable)

dictionary_cat <- dictionary_all %>%
  filter(generic_response != 'NONCATEGORICAL') %>%
  mutate(survey_response = as.character(survey_response))

```

## Add Surveys
```{r operator-read-function}
<<<<<<< HEAD

check_dropped_variables <- function(operator_variables_df, external_variables_df) {
  
  # Ensure that all variable levels in the operator specific survey have a generic 
  # equivalent in dictionary_all
  # operator_variables_df <- df_variable_levels
  # external_variables_df <- external_variable_levels
  
  external_levels <- external_variables_df %>%
    group_by(survey_variable, survey_response) %>%
    summarise(count = n()) %>%
    select(-count) %>%
    ungroup()

  missing_variables <- operator_variables_df %>%
    filter(survey_variable %in% external_levels$survey_variable) %>%
    filter(!survey_response %in% external_levels$survey_response) %>%
    nrow()

  stopifnot(missing_variables == 0)
  
}

=======

check_dropped_variables <- function(operator_variables_df, external_variables_df) {
  
  # Ensure that all variable levels in the operator specific survey have a generic 
  # equivalent in dictionary_all
  # operator_variables_df <- df_variable_levels
  # external_variables_df <- external_variable_levels
  
  external_levels <- external_variables_df %>%
    group_by(survey_variable, survey_response) %>%
    summarise(count = n()) %>%
    select(-count) %>%
    ungroup()

  missing_variables <- operator_variables_df %>%
    filter(survey_variable %in% external_levels$survey_variable) %>%
    filter(!survey_response %in% external_levels$survey_response) %>%
    nrow()

  stopifnot(missing_variables == 0)
  
}

>>>>>>> refactor_survey
check_duplicate_variables <- function(df_duplicates) {
  
  # Check for duplicate rows in dataframe
  ref_count <- df_duplicates %>% 
    group_by(ID, operator, survey_year, survey_tech, survey_variable) %>% 
    summarise(count = n())

  mult_ref_count  <- ref_count %>%
    filter(count > 1) %>%
    nrow()

  stopifnot(mult_ref_count == 0)

}
  
read_operator <- function(name, year, default_tech, file_path, variable_dictionary) {
  
<<<<<<< HEAD
  # name <- 'AC Transit'
  # year <- 2018
  # default_tech <- 'local bus'
  # file_path <- f_actransit_survey_path
=======
  # name <- 'BART'
  # year <- 2015
  # default_tech <- 'heavy rail'
  # file_path <- f_bart_survey_path
>>>>>>> refactor_survey
  # variable_dictionary <- dictionary_all
  
  variables_vector <- variable_dictionary %>%
    filter(operator == name) %>%
    .$survey_variable %>%
    unique()
  
<<<<<<< HEAD
  input_df <- read.csv(file_path, header = TRUE, comment.char = "", quote = "\"") 
  
  df_variable_levels <- input_df %>%
=======
  df <- read.csv(file_path, header = TRUE, comment.char = "", quote = "\"") 
  
  df_variable_levels <- df %>%
>>>>>>> refactor_survey
    gather(survey_variable, survey_response) %>%
    group_by(survey_variable, survey_response) %>%
    summarise(count = n()) %>%
    select(-count) %>% 
    ungroup()
    
  external_variable_levels <- variable_dictionary %>%
    filter(operator == name & generic_response != "NONCATEGORICAL")
  
  # check_dropped_variables(df_variable_levels, 
  #                         external_variable_levels)
  
<<<<<<< HEAD
  return_df <- input_df %>%
=======
  df <- df %>%
>>>>>>> refactor_survey
    select(one_of(variables_vector)) %>%
    rename_at(vars(contains('id')), funs(sub('id', 'ID', .))) %>%
    gather(survey_variable, survey_response, -ID) %>%
    mutate(ID = as.character(ID),
         operator = name,
         survey_year = year,
         survey_tech = default_tech)
  
<<<<<<< HEAD
  check_duplicate_variables(return_df)
  
  return(return_df)
=======
  check_duplicate_variables(df)
  
  return(df)
>>>>>>> refactor_survey
  
}

```

# _User Intervention #04_
When adding a new operator, create a `read_operator` call and add the resulting
dataframe to `survey_combine` in the last step.

```{r add-surveys}
bart_df <- read_operator('BART', 
                         2015, 
                         'heavy rail', 
                         f_bart_survey_path, 
                         dictionary_all)

caltrain_df <- read_operator('Caltrain',
                             2014,
                             'commuter rail',
                             f_caltrain_survey_path,
                             dictionary_all)

muni_df <- read_operator('SF Muni',
                         2017,
                         'local bus',
                         f_muni_survey_path,
                         dictionary_all)

vta_df <- read_operator('VTA',
                        2017,
                        'local bus',
                        f_vta_survey_path,
                        dictionary_all)

napa_vine_df <- read_operator('Napa Vine',
                              2014,
                              'local bus',
                              f_napa_survey_path,
                              dictionary_all)

<<<<<<< HEAD
ac_transit_df <- read_operator('AC Transit',
                               2018,
                               'local bus',
                               f_actransit_survey_path,
                               dictionary_all)

=======
>>>>>>> refactor_survey
survey_combine <- bind_rows(bart_df,
                            caltrain_df,
                            muni_df,
                            vta_df,
<<<<<<< HEAD
                            napa_vine_df,
                            ac_transit_df)

remove(bart_df, caltrain_df, muni_df, vta_df, napa_vine_df, ac_transit_df)
=======
                            napa_vine_df)

remove(bart_df, caltrain_df, muni_df, vta_df, napa_vine_df)
>>>>>>> refactor_survey

```


<<<<<<< HEAD
## Flatten
```{r flatten}
=======
## Combine across operators and flatten
```{r combine}
>>>>>>> refactor_survey

# Join the dictionary and prepare the categorical variables
survey_cat <- survey_combine %>%
  left_join(dictionary_cat, by = c("operator", "survey_variable", "survey_response")) %>%
  filter(!is.na(generic_variable))
  
# Join the dictionary and prepare the non-categorical variables
survey_non <- survey_combine %>% 
  left_join(dictionary_non, by = c("operator", "survey_variable")) %>%
  filter(!is.na(generic_variable)) %>%
  mutate(generic_response = survey_response)
  
# Combine the categorical and non-categorical survey data and prepare to flatten
survey_flat <- bind_rows(survey_cat, survey_non) %>%
  select(-survey_variable, -survey_response) %>%
  spread(generic_variable, generic_response) %>%
  arrange(operator, survey_year, ID) 

remove(survey_cat, 
       survey_non)

```

## Update Survey Technology
<<<<<<< HEAD

# _User Intervention #05_
When the operator data is read in, it assumes every route in the system uses
the same technology (e.g., all Muni routes are local bus). This is not correct,
as some operators operate multiple technologies. These bespoke technologies are
added here. See the `bespoke_survey_tech_replacement.csv` database for the changes,
which have to be crafted manually.

```{r update-tech}
survey_tech_update <- read.csv("bespoke_survey_tech_replacement.csv", 
                               colClasses = "character")

=======

# _User Intervention #05_
When the operator data is read in, it assumes every route in the system uses
the same technology (e.g., all Muni routes are local bus). This is not correct,
as some operators operate multiple technologies. These bespoke technologies are
added here. See the `bespoke_survey_tech_replacement.csv` database for the changes,
which have to be crafted manually.

```{r update-tech}
survey_tech_update <- read.csv("bespoke_survey_tech_replacement.csv", 
                               colClasses = "character")

>>>>>>> refactor_survey
survey_flat <- survey_flat %>% 
  left_join(survey_tech_update, by = c("operator", "route")) %>% 
  mutate(survey_tech = ifelse(!is.na(new_survey_tech), 
                              new_survey_tech, 
                              survey_tech)) %>%
  select(-new_survey_tech)

remove(survey_tech_update)
```


## Method Library for Standardization
```{r methods}
# Set Operator Name
set_operator_name <- function(input_vector){
  
  input_df <- as.data.frame(input_vector) %>%
    rename(input_field = input_vector)
  
  output_df <- input_df %>%
    mutate(output_field = "None") %>%
    
    # BART, AMTRAK, and Caltrain may be named in route names, so do first, then overwrite
    mutate(output_field = ifelse(str_detect(input_field, fixed("Amtrak", ignore_case = TRUE)), "AMTRAK", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("BART", ignore_case = TRUE)), "BART", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Caltrain", ignore_case = TRUE)), "CALTRAIN", output_field)) %>%
    
    # Transit Agencies
    mutate(output_field = ifelse(str_detect(input_field, fixed("AC ", ignore_case = TRUE)), "AC TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("ACE", ignore_case = TRUE)), "ACE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("AC Transit", ignore_case = TRUE)), "AC TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("AirBART", ignore_case = TRUE)), "AC TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("AirTrain", ignore_case = TRUE)), "BART", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Capitol Corridor", ignore_case = TRUE)), "AMTRAK", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("County Connection", ignore_case = TRUE)),"COUNTY CONNECTION", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Fairfield and", ignore_case = TRUE)),"FAIRFIELD-SUISUN",output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Golden Gate ", ignore_case = TRUE)), "GOLDEN GATE TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Golden Gate Tran", ignore_case = TRUE)), "GOLDEN GATE TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Golden Gate Ferry", ignore_case = TRUE)), "GOLDEN GATE FERRY", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Marin Transit", ignore_case = TRUE)), "MARIN TRANSIT", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Muni", ignore_case = TRUE)), "MUNI", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Rio Vista Delta Breeze", ignore_case = TRUE)), "RIO-VISTA", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("SamTrans", ignore_case = TRUE)), "SAMTRANS", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Sam Trans", ignore_case = TRUE)), "SAMTRANS", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Santa Rosa CityBus", ignore_case = TRUE)), "SANTA ROSA CITYBUS", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("SF Bay Ferry", ignore_case = TRUE)), "SF BAY FERRY", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Soltrans", ignore_case = TRUE)), "SOLTRANS", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Tri Delta", ignore_case = TRUE)), "TRI-DELTA", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Union City", ignore_case = TRUE)), "UNION CITY", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("WestCAT", ignore_case = TRUE)), "WESTCAT", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("VINE", ignore_case = TRUE)), "NAPA VINE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("VTA", ignore_case = TRUE)), "VTA", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("DASH Downtown Area Shuttle", ignore_case = TRUE)), "VTA", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Tiburon FERRY Tiburon To Angel Island State Park", ignore_case = TRUE)), "BLUE GOLD FERRY", output_field)) %>%
    
    # Correct AC route with 'union city' in the name
    mutate(output_field = ifelse(str_detect(input_field, fixed("AC 200 Union City BART", ignore_case = TRUE)), "AC TRANSIT", output_field)) %>%
    
    # PRIVATE SHUTTLE
    mutate(output_field = ifelse(str_detect(input_field, fixed("Stanford", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Commuter shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Corinthian lines shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Caltrain- Shuttles Genentech", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Kaiser shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("San Jose airport shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("American Canyon Safeway", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Shuttles Broadway - Millbrae", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Genentech Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Sierra Point/Brisbane Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("San Francisco General Hospital (SFGH) Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Seton Medical Center Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("UCSF Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("CPMC Hospital Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("West Berkeley Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Highland Hospital Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("San Francisco General Hospital (SFGH) Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Seton Medical Center Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Oyster Point Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Utah Grand Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Childrens Hospital Oakland", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Apple Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Facebook Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Alta Bates Shuttles", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Harbor Bay Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Alameda County employee shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("San Leandro LINKS", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("North Burlingame shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Fairmont Hospital / Juvenile Justice Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Yahoo Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Bayhill Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Bishop Ranch Shuttle", ignore_case = TRUE)), "PRIVATE SHUTTLE", output_field)) %>%
    
    # OTHER
    mutate(output_field = ifelse(str_detect(input_field, fixed("Calistoga Handy Van", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Lake Transit", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Saint Helena Shuttle", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Burlingame Trolley Shuttle", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("SCMTD Highway 17", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Santa Cruz Metro", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Menlo Park Shuttle Midday Shuttle", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Palo Alto E Embarcadero Shuttle", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("CSU East Bay Shuttle", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("UC Berkeley Campus Shuttle", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Shuttle - other or unspecified", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Unknown", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("LBL / Lawrence Berkeley Lab Shuttle", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Agency provided, but route not spec", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("San Francisco State (SFSU) Shuttle", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("PresidiGO", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Emery Go-Round", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("B on Broadway", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Estuary Crossing - College of Alameda Shuttle", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Other", ignore_case = TRUE)), "OTHER", output_field)) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Monterey-Salinas Transit", ignore_case = TRUE)), "OTHER", output_field)) %>%
    
    # Vague 'Ferry'
    mutate(output_field = ifelse(str_detect(input_field, fixed("Ferry", ignore_case = TRUE)), "SF BAY FERRY", output_field)) %>%
    mutate(output_field = ifelse(is.na(input_field), NA, output_field))
  
  return(output_df$output_field)
}

# Set Technology
set_base_technology <- function(input_vector){
  
  operator = c("ACE",                "AC TRANSIT",        "AIR BART",         
               "AMTRAK",             "BART",              "CALTRAIN",
               "COUNTY CONNECTION",  "FAIRFIELD-SUISUN",  "GOLDEN GATE TRANSIT", 
               "GOLDEN GATE FERRY",  "MARIN TRANSIT",     "MUNI",              
               "NAPA VINE",          "RIO-VISTA",         "SAMTRANS",
               "SANTA ROSA CITYBUS", "SF BAY FERRY",      "SOLTRANS",
               "TRI-DELTA",          "UNION CITY",        "WESTCAT",
               "VTA",                "OTHER",             "PRIVATE SHUTTLE",  
               "OTHER AGENCY",      "BLUE GOLD FERRY"
               )
  
  technology = c("commuter rail", "local bus",     "local bus", 
                 "commuter rail", "heavy rail",    "commuter rail", 
                 "local bus",     "local bus",     "express bus",   
                 "ferry",         "local bus",     "local bus", 
                 "local bus",     "local bus",     "local bus",
                 "local bus",     "ferry",         "local bus", 
                 "local bus",     "local bus",     "local bus",     
                 "local bus",     "local bus",     "local bus",
                 "local bus",     "ferry"
                 )
  
  tech_df <- data.frame(operator, technology)
  
  input_df <- as.data.frame(input_vector) %>% 
    rename(operator = input_vector)
  
  output_df <- left_join(input_df, tech_df, by = c("operator"))
  
  return(output_df$technology)
}

# Update Technology
update_technology <- function(input_vector){
  
  input_df <- as.data.frame(input_vector) %>%
    rename(input_field = input_vector)
  
  output_df <- input_df %>%
    mutate(output_field = "No Update") %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("Muni", ignore_case = TRUE)) &
                                 str_detect(input_field, fixed("Light Rail", ignore_case = TRUE)),
                                 "light rail", 
                                 output_field
                                 )
           ) %>%
    mutate(output_field = ifelse(str_detect(input_field, fixed("VTA", ignore_case = TRUE)) &
                                 str_detect(input_field, fixed("Light Rail", ignore_case = TRUE)), 
                                 "light rail", 
                                 output_field
                                 )
           ) %>%
    mutate(output_field = ifelse(is.na(input_field), NA, output_field))
  
  return(output_df$output_field)
}

```

# _User Intervention 06_
User should run each of the `Steps` below individually and make sure the results make sense.
In addition, the `debug_transfers` frame should be empty. If it's not, the code
has failed to identify an operator or technology for a route that is being
transferred to or from. 

## Build Standard variables
```{r standard-variables-part1}
# Step 1:  Age-related transformations
# -------------------------------------------------------------------------------------

# Standardize year born
survey_standard <- survey_flat %>%
  mutate(year_born = ifelse(str_detect(year_born_four_digit, "Missing"), 
                            NA, 
                            year_born_four_digit)) %>%
  mutate(year_born = ifelse(is.na(year_born), NA, as.numeric(year_born))) %>%
  select(-year_born_four_digit)

# Manual fixes to year born
survey_standard <- survey_standard %>%
  mutate(survey_year = as.numeric(survey_year)) %>%
  mutate(year_born = ifelse(year_born == 1900, 2000, year_born)) %>%
  mutate(year_born = ifelse(year_born == 1901, 2001, year_born)) %>%
  mutate(year_born = ifelse(year_born == 3884, 1984, year_born)) %>%
  mutate(year_born = ifelse(year_born == 1899, NA, year_born))

table(survey_standard$year_born)

# Compute approximate respondent age 
survey_standard <- survey_standard %>%
  mutate(approximate_age = ifelse(!is.na(year_born) & survey_year >= year_born, survey_year - year_born, NA))

table(survey_standard$approximate_age)

# Step 2:  Trip- and tour-purpose-related transformations
# -------------------------------------------------------------------------------------

# Recode key variables from NA to 'missing'
survey_standard <- survey_standard %>%
  mutate(orig_purp = ifelse(is.na(orig_purp), 'missing', orig_purp)) %>%
  mutate(dest_purp = ifelse(is.na(dest_purp), 'missing', dest_purp)) %>%
  mutate(work_status = ifelse(is.na(work_status), 'missing', work_status)) %>%
  mutate(student_status = ifelse(is.na(student_status), 'missing', student_status)) %>%
  mutate(approximate_age = ifelse(is.na(approximate_age), 'missing', approximate_age)) %>%
  mutate(at_work_prior_to_orig_purp = ifelse(is.na(at_work_prior_to_orig_purp), 'not relevant', at_work_prior_to_orig_purp)) %>%
  mutate(at_work_after_dest_purp = ifelse(is.na(at_work_after_dest_purp), 'not relevant', at_work_after_dest_purp)) %>%
  mutate(at_school_prior_to_orig_purp = ifelse(is.na(at_school_prior_to_orig_purp), 'not relevant', at_school_prior_to_orig_purp)) %>%
  mutate(at_school_after_dest_purp = ifelse(is.na(at_school_after_dest_purp), 'not relevant', at_school_after_dest_purp))

# Refine school purpose
survey_standard <- survey_standard %>%
  mutate(orig_purp = ifelse(orig_purp == "school", "high school", orig_purp)) %>%
  mutate(orig_purp = ifelse(orig_purp == "school" & approximate_age < 14, 
                            "grade_school", orig_purp))

# (Approximate) Tour purpose
survey_standard <- survey_standard %>%
  mutate(tour_purp = 'missing') %>%
  
  # workers -- simple
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              orig_purp == 'home' & 
                              dest_purp == 'work', 
                            'work', 
                            tour_purp)) %>%
  
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              orig_purp == 'work' & 
                              dest_purp == 'home', 
                            'work', 
                            tour_purp)) %>%
  
  # students -- simple
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              (orig_purp == 'grade school' | dest_purp == 'grade school'), 
                            'grade school', 
                            tour_purp)) %>%
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              (orig_purp == 'high school' | dest_purp == 'high school'),  
                            'high school', tour_purp)) %>%
  
  # non-working university students
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              work_status == 'non-worker' & 
                              (orig_purp == 'college'  | dest_purp == 'college'),  
                            'university', 
                            tour_purp) ) %>%
  
  # non-workers, non-students, home-based travel
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              work_status == 'non-worker' & 
                              student_status == 'non-student' & 
                              orig_purp == 'home', 
                            dest_purp, tour_purp)) %>%
  
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              work_status == 'non-worker' & 
                              student_status == 'non-student' & 
                              dest_purp == 'home', 
                            orig_purp, 
                            tour_purp)) %>%
  
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              work_status == 'non-worker' & 
                              student_status == 'non-student' & 
                              orig_purp == dest_purp, 
                            orig_purp, 
                            tour_purp)) %>%
  
  # non-workers, non-students, non-home-based (which we know from above implementation) escorting travel
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              work_status == 'non-worker' & 
                              student_status == 'non-student' & 
                              (orig_purp == 'escorting' | dest_purp == 'escorting'), 
                            'escorting', 
                            tour_purp)) %>%
  
  # university is present, but work is not, then university
  mutate(tour_purp = ifelse(tour_purp == 'missing' 
                            & at_work_prior_to_orig_purp == 'not at work before surveyed trip' 
                            & at_work_after_dest_purp == 'not at work after surveyed trip' & 
                              (orig_purp == 'college' | dest_purp == 'college'), 
                            'university', 
                            tour_purp) ) %>%
  
  # if work before trip and home after, assume work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              at_work_prior_to_orig_purp == 'at work before surveyed trip' & 
                              dest_purp == 'home', 
                            'work', 
                            tour_purp)) %>%
  
  # if work after trip and home before, assume work tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                               at_work_after_dest_purp == 'at work after surveyed trip' & 
                               orig_purp == 'home', 
                             'work', 
                             tour_purp)) %>%
  
  # if non-worker, school before trip and home after, over 18, university tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                               work_status == 'non-worker' & 
                               at_school_prior_to_orig_purp == 'at school before surveyed trip' & 
                               approximate_age > 18 & 
                               dest_purp == 'home', 
                             'university', 
                             tour_purp)) %>%
  
  # if non-worker, school after trip and home before, over 18, university tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                               work_status == 'non-worker' & 
                               at_school_after_dest_purp == 'at school after surveyed trip' & 
                               approximate_age > 18 & 
                               orig_purp == 'home', 
                             'college', 
                             tour_purp)) %>%
  
    # if non-worker, school before trip and home after, 14 to 18, high school tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                               work_status == 'non-worker' & 
                               at_school_prior_to_orig_purp == 'at school before surveyed trip' & 
                               approximate_age <= 18 & 
                               approximate_age >= 14 & 
                               dest_purp == 'home', 
                             'high school', 
                             tour_purp)) %>%
  
  # if non-worker, school after trip and home before, 14 to 18, high school tour
   mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                               work_status == 'non-worker' & 
                               at_school_after_dest_purp == 'at school after surveyed trip' & 
                               approximate_age <= 18 & 
                               approximate_age >= 14 & 
                               orig_purp == 'home', 
                             'high school', 
                             tour_purp)) %>%
  
  # if no work before or after, but work is a leg, assume a work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              at_work_prior_to_orig_purp == 'not at work before surveyed trip' & 
                              at_work_after_dest_purp == 'not at work after surveyed trip' & 
                              (orig_purp == 'work' | dest_purp == 'work'), 
                            'work', 
                            tour_purp)) %>%
  
  # at work tours
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              at_work_prior_to_orig_purp == 'at work before surveyed trip' & 
                              dest_purp == 'work', 
                            'at work', 
                            tour_purp) ) %>%
  
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              at_work_after_dest_purp == 'at work after surveyed trip' & 
                              orig_purp == 'work', 
                            'at work', 
                            tour_purp)) %>%
  
  # if still left and work before or after the trip, assume work tour
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              at_work_after_dest_purp == 'at work after surveyed trip' & 
                              at_work_prior_to_orig_purp == 'at work before surveyed trip', 
                            'work', 
                            tour_purp)) %>%
  
  # if still left and home is one end, chose the other as the purpose
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              orig_purp == 'home', 
                            dest_purp, 
                            tour_purp)) %>%
  
  mutate(tour_purp = ifelse(tour_purp == 'missing' & 
                              dest_purp == 'home', 
                            orig_purp, 
                            tour_purp)) %>%
  
  # if still left, pick the orig_purp
  mutate(tour_purp = ifelse(tour_purp == 'missing', orig_purp, tour_purp))
           
table(survey_standard$tour_purp)

# Step 3:  Update Key locations and Status Flags
# -------------------------------------------------------------------------------------

# Home
survey_standard <- survey_standard %>%
  mutate(home_lat = ifelse(orig_purp == 'home' & is.na(home_lat), 
                           orig_lat, 
                           home_lat)) %>%
  mutate(home_lon = ifelse(orig_purp == 'home' & is.na(home_lon), 
                           orig_lon, 
                           home_lon)) %>%
  mutate(home_lat = ifelse(dest_purp == 'home' & is.na(home_lat), 
                           dest_lat, 
                           home_lat)) %>%
  mutate(home_lon = ifelse(dest_purp == 'home' & is.na(home_lon), 
                           dest_lon, 
                           home_lon) ) %>%
  
# Work
  mutate(workplace_lat = ifelse(orig_purp == 'work' & is.na(workplace_lat), 
                                orig_lat, 
                                workplace_lat)) %>%
  mutate(workplace_lon = ifelse(orig_purp == 'work' & is.na(workplace_lon), 
                                orig_lon, 
                                workplace_lon)) %>%
  mutate(workplace_lat = ifelse(dest_purp == 'work' & is.na(workplace_lat), 
                                dest_lat, 
                                workplace_lat)) %>%
  mutate(workplace_lon = ifelse(dest_purp == 'work' & is.na(workplace_lon), 
                                dest_lon, 
                                workplace_lon)) %>%
  
# School
  mutate(school_lat = ifelse(orig_purp %in% c('grade school', 'high school', 'college') & 
                               is.na(school_lat), 
                             orig_lat, 
                             school_lat)) %>%
  mutate(school_lon = ifelse(orig_purp %in% c('grade school', 'high school', 'college') & 
                               is.na(school_lon), 
                             orig_lon, 
                             school_lon)) %>%
  mutate(school_lat = ifelse(dest_purp %in% c('grade school', 'high school', 'college') & 
                               is.na(school_lat), 
                             dest_lat, 
                             school_lat)) %>%
  mutate(school_lon = ifelse(orig_purp %in% c('grade school', 'high school', 'college') & 
                               is.na(school_lon), 
                             dest_lon, 
                             school_lon)) 
  
# Work and Student status
survey_standard <- survey_standard %>%
  mutate(work_status = ifelse(orig_purp == 'work' | dest_purp == 'work', 
                              'full- or part-time', 
                              work_status)) %>%
  mutate(student_status = ifelse(orig_purp == 'grade school' | 
                                   dest_purp == 'grade school', 
                                 'full- or part-time', 
                                 student_status)) %>%
  mutate(student_status = ifelse(orig_purp == 'high school' | 
                                   dest_purp == 'high school', 
                                 'full- or part-time', 
                                 student_status)) %>%
  mutate(student_status = ifelse(orig_purp == 'college' | 
                                   dest_purp == 'college',
                                 'full- or part-time', 
                                 student_status))

# Step 4:  Automobile Sufficiency
# -------------------------------------------------------------------------------------

# Transform vehicles and workers to standard scale
survey_standard <- survey_standard %>%
  mutate(vehicles = ifelse(vehicles == 'other', vehicles_additional_info, vehicles)) %>%
  mutate(workers = ifelse(workers == 'other', workers_additional_info,  workers))

table(survey_standard$vehicles)
table(survey_standard$workers)

vehicles_dictionary <- data.frame(
  vehicles = c('zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 
               'eight', 'nine', 'ten', 'eleven', 'twelve', 'four or more'), 
  vehicle_numeric_cat = c(0, 1, 2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4))

workers_dictionary <- data.frame(
  workers = c('zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 
              'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 
              'fifteen', 'six or more'), 
  worker_numeric_cat = c(0, 1, 2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4))

survey_standard <- left_join(survey_standard, vehicles_dictionary, by = c("vehicles"))
survey_standard <- left_join(survey_standard, workers_dictionary, by = c("workers"))

survey_standard <- survey_standard %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat == 0, 'zero autos', 'missing')) %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat > 0 & 
                              worker_numeric_cat > 0  & 
                              worker_numeric_cat >  vehicle_numeric_cat, 
                            'auto negotiating', 
                            auto_suff)) %>%
  mutate(auto_suff = ifelse(vehicle_numeric_cat > 0 & 
                              worker_numeric_cat >= 0 & 
                              worker_numeric_cat <= vehicle_numeric_cat, 
                            'auto sufficient', 
                            auto_suff))

table(survey_standard$auto_suff)

remove(vehicles_dictionary, 
       workers_dictionary)


# Step 5:  Operator and Technology sequence
# -------------------------------------------------------------------------------------

# Set operator for each of six legs (three before, three after)
# - remove BART 'Missing - Dummy Record' before starting
# - remove Muni 'None' before starting
survey_standard <- survey_standard %>%
  mutate(first_route_before_survey_board = ifelse(first_route_before_survey_board == "Missing - Dummy Record", 
                                                  "", 
                                                  first_route_before_survey_board) ) %>%
  mutate(second_route_before_survey_board = ifelse(second_route_before_survey_board == "Missing - Dummy Record", 
                                                   "", 
                                                   second_route_before_survey_board)) %>%
  mutate(third_route_before_survey_board = ifelse(third_route_before_survey_board == "Missing - Dummy Record", 
                                                  "", 
                                                  third_route_before_survey_board))

survey_standard <- survey_standard %>%
  mutate(first_route_after_survey_alight = ifelse(first_route_after_survey_alight == "Missing - Dummy Record", 
                                                  "", 
                                                  first_route_after_survey_alight)) %>%
  mutate(second_route_after_survey_alight = ifelse(second_route_after_survey_alight == "Missing - Dummy Record", 
                                                   "", 
                                                   second_route_after_survey_alight)) %>%
  mutate(third_route_after_survey_alight = ifelse(third_route_after_survey_alight == "Missing - Dummy Record", 
                                                  "", 
                                                  third_route_after_survey_alight)) 

first_before <- as.data.frame(set_operator_name(survey_standard$first_route_before_survey_board))
colnames(first_before) <- c("first_before_operator")

second_before <- as.data.frame(set_operator_name(survey_standard$second_route_before_survey_board))
colnames(second_before) <- c("second_before_operator")

third_before <- as.data.frame(set_operator_name(survey_standard$third_route_before_survey_board))
colnames(third_before) <- c("third_before_operator")

first_after <- as.data.frame(set_operator_name(survey_standard$first_route_after_survey_alight))
colnames(first_after) <- c("first_after_operator")

second_after <- as.data.frame(set_operator_name(survey_standard$second_route_after_survey_alight))
colnames(second_after) <- c("second_after_operator")

third_after <- as.data.frame(set_operator_name(survey_standard$third_route_after_survey_alight))
colnames(third_after) <- c("third_after_operator")

survey_standard <- survey_standard %>%
  bind_cols(first_before, 
            second_before, 
            third_before, 
            first_after, 
            second_after, 
            third_after)

# Set the technology for each of the six legs
first_before <- as.data.frame(set_base_technology(survey_standard$first_before_operator))
colnames(first_before) <- c("first_before_technology")

second_before <- as.data.frame(set_base_technology(survey_standard$second_before_operator))
colnames(second_before) <- c("second_before_technology")

third_before <- as.data.frame(set_base_technology(survey_standard$third_before_operator))
colnames(third_before) <- c("third_before_technology")

first_after <- as.data.frame(set_base_technology(survey_standard$first_after_operator))
colnames(first_after) <- c("first_after_technology")

second_after <- as.data.frame(set_base_technology(survey_standard$second_after_operator))
colnames(second_after) <- c("second_after_technology")

third_after <- as.data.frame(set_base_technology(survey_standard$third_after_operator))
colnames(third_after) <- c("third_after_technology")

survey_standard <- survey_standard %>%
  bind_cols(first_before, 
            second_before, 
            third_before, 
            first_after, 
            second_after, 
            third_after )

# Update the technology
first_before <- as.data.frame(update_technology(survey_standard$first_route_before_survey_board))
colnames(first_before) <- c("first_before_update_tech")

second_before <- as.data.frame(update_technology(survey_standard$second_route_before_survey_board))
colnames(second_before) <- c("second_before_update_tech")

third_before <- as.data.frame(update_technology(survey_standard$third_route_before_survey_board))
colnames(third_before) <- c("third_before_update_tech")

first_after <- as.data.frame(update_technology(survey_standard$first_route_after_survey_alight))
colnames(first_after) <- c("first_after_update_tech")

second_after <- as.data.frame(update_technology(survey_standard$second_route_after_survey_alight))
colnames(second_after) <- c("second_after_update_tech")

third_after <- as.data.frame(update_technology(survey_standard$third_route_after_survey_alight))
colnames(third_after) <- c("third_after_update_tech")

survey_standard <- survey_standard %>%
  bind_cols(first_before, 
            second_before, 
            third_before, 
            first_after, 
            second_after, 
            third_after)  
<<<<<<< HEAD

table(survey_standard$first_before_technology)

=======

table(survey_standard$first_before_technology)

>>>>>>> refactor_survey
survey_standard <- survey_standard %>%
  mutate(first_before_technology = ifelse(first_before_update_tech != "No Update", 
                                          as.character(first_before_update_tech),  
                                          as.character(first_before_technology))) %>%
  
  mutate(second_before_technology = ifelse(second_before_update_tech != "No Update", 
                                           as.character(second_before_update_tech), 
                                           as.character(second_before_technology))) %>%
  
  mutate(third_before_technology = ifelse(third_before_update_tech != "No Update", 
                                           as.character(third_before_update_tech),  
                                           as.character(third_before_technology))) %>%
  
  mutate(first_after_technology = ifelse(first_after_update_tech != "No Update", 
                                         as.character(first_after_update_tech),  
                                         as.character(first_after_technology))) %>%
  
  mutate(second_after_technology = ifelse(second_after_update_tech != "No Update", 
                                          as.character(second_after_update_tech),  
                                          as.character(second_after_technology))) %>%
  
  mutate(third_after_technology = ifelse(third_after_update_tech != "No Update", 
                                         as.character(third_after_update_tech),
                                         as.character(third_after_technology)))

table(survey_standard$first_before_technology)

# Clean up
remove(first_before, 
       second_before, 
       third_before, 
       first_after, 
       second_after, 
       third_after)

survey_standard <- survey_standard %>%
  select(-first_before_update_tech, 
         -second_before_update_tech, 
         -third_before_update_tech, 
         -first_after_update_tech, 
         -second_after_update_tech, 
         -third_after_update_tech)


# Step 6:  Travel Model One path details
# -------------------------------------------------------------------------------------

# Transfer to and from
survey_standard <- survey_standard %>%
  mutate(transfer_from = as.character(first_before_operator)) %>%
  mutate(transfer_from = ifelse(second_before_operator != 'None', 
                                as.character(second_before_operator), 
                                transfer_from)) %>%
  
  mutate(transfer_from = ifelse(third_before_operator  != 'None', 
                                as.character(third_before_operator),
                                transfer_from)) %>%
  
  mutate(transfer_to = as.character(first_after_operator))

# First boarding and last alighting technology
survey_standard <- survey_standard %>%
  mutate(first_board_tech = as.character(survey_tech)) %>%
  mutate(first_board_tech = ifelse(!is.na(first_before_technology), 
                                   first_before_technology, 
                                   first_board_tech)) %>%
  
  mutate(last_alight_tech = as.character(survey_tech)) %>%
  mutate(last_alight_tech = ifelse(!is.na(first_after_technology),
                                   first_after_technology,
                                   last_alight_tech)) %>%
  
  mutate(last_alight_tech = ifelse(!is.na(second_after_technology), 
                                   second_after_technology, 
                                   last_alight_tech)) %>%
  
  mutate(last_alight_tech = ifelse(!is.na(third_after_technology),
                                   third_after_technology,
                                   last_alight_tech))

table(survey_standard$transfer_from)
table(survey_standard$transfer_to)
table(survey_standard$survey_tech)
table(survey_standard$first_board_tech)
table(survey_standard$last_alight_tech)

# Travel Model One path (re-write to acknowledge NA explicitly)
# -- Access
survey_standard <- survey_standard %>%
  mutate(path_access = "X") %>%
  mutate(path_access = ifelse(access_mode == "walk", "W", path_access)) %>%
  mutate(path_access = ifelse(access_mode == "pnr" , "D", path_access)) %>%
  mutate(path_access = ifelse(access_mode == "knr" , "D", path_access)) %>%
  mutate(path_access = ifelse(access_mode == "bike", "D", path_access)) %>%
  mutate(path_access = ifelse(is.na(access_mode), "X", path_access))

table(survey_standard$path_access)

# -- Egress
survey_standard <- survey_standard %>%
  mutate(path_egress = "X") %>%
  mutate(path_egress = ifelse(egress_mode == "walk", "W", path_egress)) %>%
  mutate(path_egress = ifelse(egress_mode == "pnr" , "D", path_egress)) %>%
  mutate(path_egress = ifelse(egress_mode == "knr" , "D", path_egress)) %>%
  mutate(path_egress = ifelse(egress_mode == "bike", "D", path_egress)) %>%
  mutate(path_egress = ifelse(is.na(egress_mode), "X", path_egress))

table(survey_standard$path_egress)

# -- Line haul
# --- Technology present calculations
survey_standard <- survey_standard %>%
  mutate(first_before_technology = ifelse(is.na(first_before_technology),  
                                           "Missing", 
                                           first_before_technology)) %>%
  mutate(second_before_technology = ifelse(is.na(second_before_technology), 
                                           "Missing", 
                                           second_before_technology)) %>%
  mutate(third_before_technology = ifelse(is.na(third_before_technology), 
                                          "Missing", 
                                          third_before_technology)) %>%
  mutate(first_after_technology = ifelse(is.na(first_after_technology),
                                         "Missing",
                                         first_after_technology)) %>%
  mutate(second_after_technology = ifelse(is.na(second_after_technology),
                                          "Missing",
                                          second_after_technology)) %>%
  mutate(third_after_technology = ifelse(is.na(third_after_technology),
                                         "Missing",
                                         third_after_technology))

helper_relevant_tech <- 'commuter rail'
survey_standard <- survey_standard %>%
  mutate(commuter_rail_present = FALSE) %>%
  mutate(commuter_rail_present = first_before_technology == helper_relevant_tech |
           second_before_technology == helper_relevant_tech |
           third_before_technology == helper_relevant_tech | 
           first_after_technology == helper_relevant_tech |
           second_after_technology == helper_relevant_tech |
           third_after_technology == helper_relevant_tech)

table(survey_standard$commuter_rail_present)

helper_relevant_tech <- 'heavy rail'
survey_standard <- survey_standard %>%
  mutate(heavy_rail_present = FALSE) %>%
  mutate(heavy_rail_present = first_before_technology == helper_relevant_tech |
           second_before_technology == helper_relevant_tech |
           third_before_technology == helper_relevant_tech | 
           first_after_technology == helper_relevant_tech |
           second_after_technology == helper_relevant_tech |
           third_after_technology == helper_relevant_tech)

table(survey_standard$heavy_rail_present)

helper_relevant_tech <- 'express bus'
survey_standard <- survey_standard %>%
  mutate(express_bus_present = FALSE) %>%
  mutate(express_bus_present = first_before_technology == helper_relevant_tech |
           second_before_technology == helper_relevant_tech |
           third_before_technology == helper_relevant_tech | 
           first_after_technology == helper_relevant_tech |
           second_after_technology == helper_relevant_tech |
           third_after_technology == helper_relevant_tech)

table(survey_standard$express_bus_present)

helper_relevant_tech <- 'ferry'
survey_standard <- survey_standard %>%
  mutate(ferry_present = FALSE) %>%
  mutate(ferry_present = first_before_technology == helper_relevant_tech |
           second_before_technology == helper_relevant_tech |
           third_before_technology == helper_relevant_tech | 
           first_after_technology == helper_relevant_tech |
           second_after_technology == helper_relevant_tech |
           third_after_technology == helper_relevant_tech)

table(survey_standard$ferry_present)

helper_relevant_tech <- 'light rail'
survey_standard <- survey_standard %>%
  mutate(light_rail_present = FALSE) %>%
  mutate(light_rail_present = first_before_technology == helper_relevant_tech |
           second_before_technology == helper_relevant_tech |
           third_before_technology == helper_relevant_tech | 
           first_after_technology == helper_relevant_tech |
           second_after_technology == helper_relevant_tech |
           third_after_technology == helper_relevant_tech)
<<<<<<< HEAD

table(survey_standard$light_rail_present)


=======

table(survey_standard$light_rail_present)


>>>>>>> refactor_survey
survey_standard <- survey_standard %>%
  mutate(path_line_haul = "LOC") %>%
  mutate(path_line_haul = ifelse(light_rail_present,    
                                 "LRF", 
                                 path_line_haul)) %>%
  mutate(path_line_haul = ifelse(ferry_present,         
                                 "LRF", 
                                 path_line_haul)) %>%
  mutate(path_line_haul = ifelse(express_bus_present,   
                                 "EXP",
                                 path_line_haul)) %>%
  mutate(path_line_haul = ifelse(heavy_rail_present,    
                                 "HVY", 
                                 path_line_haul)) %>%
  mutate(path_line_haul = ifelse(commuter_rail_present, "COM", path_line_haul)) %>%
  mutate(path_label = paste(path_access, path_line_haul, path_egress, sep = "-"))

table(survey_standard$path_label)
           
# Boardings
survey_standard <- survey_standard %>%
  mutate(boardings = 1L) %>%
  mutate(boardings = ifelse(!(first_before_technology  == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(second_before_technology == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(third_before_technology  == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(first_after_technology   == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(second_after_technology  == "Missing"), boardings + 1, boardings)) %>%
  mutate(boardings = ifelse(!(third_after_technology   == "Missing"), boardings + 1, boardings))

table(survey_standard$boardings)

# If missing, compute number_transfers_orig_board and number_transfers_alight_dest
survey_standard <- survey_standard %>%
  mutate(first  = ifelse(str_length(first_route_before_survey_board)  == 0L, 0, 1)) %>%
  mutate(second = ifelse(str_length(second_route_before_survey_board) == 0L, 0, 1)) %>%
  mutate(third  = ifelse(str_length(third_route_before_survey_board)  == 0L, 0, 1)) %>%
  mutate(number_transfers_orig_board = ifelse(is.na(number_transfers_orig_board), 
         first + second + third, number_transfers_orig_board)) %>%
  mutate(first  = ifelse(str_length(first_route_after_survey_alight)  == 0L, 0, 1)) %>%
  mutate(second = ifelse(str_length(second_route_after_survey_alight) == 0L, 0, 1)) %>%
  mutate(third  = ifelse(str_length(third_route_after_survey_alight)  == 0L, 0, 1)) %>%
  mutate(number_transfers_alight_dest = ifelse(is.na(number_transfers_alight_dest), 
         first + second + third, number_transfers_alight_dest)) %>%
  select(-first, -second, -third)

table(survey_standard$number_transfers_orig_board)
table(survey_standard$number_transfers_alight_dest)

survey_standard <- survey_standard %>%
  mutate(survey_boardings = 1L + 
           as.numeric(number_transfers_orig_board) + 
           as.numeric(number_transfers_alight_dest) )

table(survey_standard$boardings, survey_standard$survey_boardings)

# Build debug data frame to find odds and ends
debug_transfers <- survey_standard %>%
  filter(!(boardings == survey_boardings)) %>%
  select(ID, operator, route, direction,
         boardings, survey_boardings,
         first_route_before_survey_board,  first_before_operator,  first_before_technology,
         second_route_before_survey_board, second_before_operator, second_before_technology,
         third_route_before_survey_board,  third_before_operator,  third_before_technology,
         first_route_after_survey_alight,   first_after_operator,  first_after_technology,
         second_route_after_survey_alight, second_after_operator, second_after_technology,
         third_route_after_survey_alight,  third_after_operator,  third_after_technology)

survey_standard <- survey_standard %>%
  select(-survey_boardings, -commuter_rail_present, -heavy_rail_present, 
         -ferry_present, -light_rail_present, -express_bus_present)

```


```{r standard-variables-part2}
# Step 7:  Standardize Demographics
# -------------------------------------------------------------------------------------
survey_standard <- survey_standard %>%
  
  # Race
  mutate(race_dmy_ind = as.numeric(race_dmy_ind)) %>%
  mutate(race_dmy_asn = as.numeric(race_dmy_asn)) %>%
  mutate(race_dmy_blk = as.numeric(race_dmy_blk)) %>%
  mutate(race_dmy_hwi = as.numeric(race_dmy_hwi)) %>%
  mutate(race_dmy_wht = as.numeric(race_dmy_wht)) %>%
  mutate(race_dmy_oth = ifelse(str_length(as.character(race_other_string)) > 2, 1L, 0L)) %>%
  mutate(race_dmy_sum = race_dmy_ind + race_dmy_asn + race_dmy_blk + race_dmy_hwi + race_dmy_wht + race_dmy_oth) %>%
  
  mutate(race = 'OTHER') %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_ind == 1, 'OTHER', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_asn == 1, 'ASIAN', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_blk == 1, 'BLACK', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_hwi == 1, 'OTHER', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_wht == 1, 'WHITE', race)) %>%
  mutate(race = ifelse(race_dmy_sum == 1 & race_dmy_oth == 1, 'OTHER', race)) %>%
  
  # Language at home
  mutate(language_at_home = ifelse(as.character(language_at_home_binary) == 'OTHER', 
                                   as.character(language_at_home_detail), 
                                   as.character(language_at_home_binary))) %>%
  select(-language_at_home_binary, 
         -language_at_home_detail, 
         -race_dmy_ind, 
         -race_dmy_asn, 
         -race_dmy_blk, 
         -race_dmy_hwi,
         -race_dmy_wht, 
         -race_dmy_oth, 
         -race_dmy_sum, 
         -race_other_string)

# Update fare medium for surveys with clipper detail
survey_standard <- survey_standard %>%
  mutate(fare_medium = ifelse(is.na(clipper_detail), fare_medium, clipper_detail)) %>%
  select(-clipper_detail)

table(survey_standard$work_status)
table(survey_standard$student_status)
table(survey_standard$fare_medium)
table(survey_standard$fare_category)
table(survey_standard$hispanic)
table(survey_standard$race)
table(survey_standard$language_at_home)
table(survey_standard$household_income)
table(survey_standard$eng_proficient)
  
# Step 8:  Create route if needed, set dates and times
# -------------------------------------------------------------------------------------

# Build route from entry and exit station, as needed
survey_standard <- survey_standard %>%
  mutate(route = ifelse(!is.na(onoff_enter_station), 
                        paste(onoff_enter_station, onoff_exit_station, sep = " "), 
                        route))

# Deal with date and time
survey_standard <- survey_standard %>%
  mutate(date_string = ifelse(str_length(date_string) == 0, NA, date_string)) %>%
  mutate(time_string = ifelse(str_length(time_string) == 0, NA, time_string))

# Deal with BART's missing (currently only have weekday data, update when we add in weekend)
survey_standard <- survey_standard %>%
  mutate(date_string = ifelse(date_string == "Missing - Dummy Record", NA, date_string)) %>%
  mutate(date_string = ifelse(date_string == "Missing - Question Not Asked", NA, date_string)) %>%
  mutate(weekpart = ifelse(is.na(date_string), "WEEKDAY", weekpart))

#table(survey_standard$date_string)
#table(survey_standard$time_string)

# Get day of the week from date
survey_standard <- survey_standard %>%
  mutate(date = as.Date(date_string, format = "%m/%d/%Y")) %>%
  mutate(day_of_the_week = toupper(weekdays(date)))

table(survey_standard$operator, survey_standard$day_of_the_week)

# Fill in missing weekpart
survey_standard <- survey_standard %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "SUNDAY",   "WEEKEND", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "MONDAY",   "WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "TUESDAY",  "WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "WEDNESDAY","WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "THURSDAY", "WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "FRIDAY",   "WEEKDAY", weekpart)) %>%
  mutate(weekpart = ifelse(is.na(weekpart) & day_of_the_week == "SATURDAY", "WEEKEND", weekpart))

table(survey_standard$operator,survey_standard$weekpart)

# Get field dates from date
field_dates <- survey_standard %>%
  group_by(operator, survey_year) %>%
  filter(!is.na(date)) %>%
  summarise(field_start = min(date), field_end = max(date))

survey_standard <- survey_standard %>% 
  left_join(field_dates, by = c("operator", "survey_year"))

# Deal with time
survey_standard <- survey_standard %>%
  mutate(time_string = ifelse(time_string == "Missing - Dummy Record", NA, time_string)) %>%
  mutate(time_string = ifelse(time_string == "Missing - Question Not Asked", NA, time_string)) %>%
  # interpret the time string
  mutate(time1 = as.POSIXct(strptime(time_string, format = "%l:%M:%S %p"))) %>%
  mutate(time2 = as.POSIXct(strptime(time_string, format = "%l:%M %p"))) %>%
  mutate(time3 = as.POSIXct(strptime(time_string, format = "%H:%M:%S"))) %>%
  mutate(time4 = as.POSIXct(strptime(time_string, format = "%H:%M"))) %>%
  mutate(survey_time_posix = as.POSIXct(ifelse(!is.na(time1), time1,
                                               ifelse(!is.na(time2), 
                                                      time2,
                                                      ifelse(!is.na(time3), 
                                                             time3, 
                                                             time4))), 
                                        origin="1970-01-01")
         ) %>%
  # create a time_start (in hours) for day_part
  mutate(time_start = as.numeric(format(survey_time_posix,"%H"))) %>%
  mutate(day_part = 'EVENING') %>%
  mutate(day_part = ifelse(time_start > 2  & time_start < 6,  'EARLY AM', day_part)) %>%
  mutate(day_part = ifelse(time_start > 5  & time_start < 11, 'AM PEAK' , day_part)) %>%
  mutate(day_part = ifelse(time_start > 10 & time_start < 15, 'MIDDAY'  , day_part)) %>%
  mutate(day_part = ifelse(time_start > 14 & time_start < 19, 'PM PEAK' , day_part)) %>%
  # keep survey_time to output
  mutate(survey_time=format(survey_time_posix, format="%H:%M:%S"))

table(survey_standard$field_start)
table(survey_standard$field_end)
table(survey_standard$time_start)
table(survey_standard$day_part)
table(survey_standard$day_of_the_week)

survey_standard <- survey_standard %>%
  select(-date_string, -time_string, -time1, -time2, 
         -time3, -time4, -survey_time_posix)

```

### Geocode XY to Travel Model Geographies 
```{r geocode-doit}
# Prepare and write locations that need to be geo-coded to disk
survey_standard <- survey_standard %>%
  mutate(unique_ID = paste(ID, operator, survey_year, sep = "---"))

temp_lat <- survey_standard %>%
  select(unique_ID, dest = dest_lat, home = home_lat, orig = orig_lat, 
         school = school_lat, workplace = workplace_lat)

temp_lon <- survey_standard %>%
  select(unique_ID, dest = dest_lon, home = home_lon, orig = orig_lon, 
         school = school_lon, workplace = workplace_lon)

temp_lat_gather <- temp_lat %>%
  gather(variable, y_coord, -unique_ID)

temp_lon_gather <- temp_lon %>%
  gather(variable, x_coord, -unique_ID)

write_places <- temp_lat_gather %>%
  left_join(temp_lon_gather, by = c("unique_ID", "variable"))

write_places <- write_places %>%
  mutate(x_coord = as.numeric(x_coord)) %>%
  mutate(y_coord = as.numeric(y_coord)) %>%
  filter(!is.na(x_coord)) %>%
  filter(!is.na(y_coord))

survey_standard <- survey_standard %>%
  mutate(first_board_lat  = ifelse(number_transfers_orig_board == 0,  survey_board_lat,  first_board_lat)) %>%
  mutate(first_board_lon  = ifelse(number_transfers_orig_board == 0,  survey_board_lon,  first_board_lon)) %>%
  mutate(first_board_tech = ifelse(number_transfers_orig_board == 0,  survey_tech,       first_board_tech)) %>%
  mutate(last_alight_lat  = ifelse(number_transfers_alight_dest == 0, survey_alight_lat, last_alight_lat)) %>%
  mutate(last_alight_lon  = ifelse(number_transfers_alight_dest == 0, survey_alight_lon, last_alight_lon)) %>%
  mutate(last_alight_tech = ifelse(number_transfers_alight_dest == 0, survey_tech,       last_alight_tech))

write_board <- survey_standard %>%
  select(unique_ID, first_board_lat, first_board_lon, first_board_tech) %>%
  mutate(first_board_lat = as.numeric(first_board_lat)) %>%
  mutate(first_board_lon = as.numeric(first_board_lon)) %>%
  filter(!is.na(first_board_lat)) %>%
  filter(!is.na(first_board_lon))

write_alight <- survey_standard %>%
  select(unique_ID, last_alight_lat, last_alight_lon, last_alight_tech) %>%
  mutate(last_alight_lat = as.numeric(last_alight_lat)) %>%
  mutate(last_alight_lon = as.numeric(last_alight_lon)) %>%
  filter(!is.na(last_alight_lat)) %>%
  filter(!is.na(last_alight_lon))

write.csv(write_places, file = f_spatial_to_be_geocoded_path, row.names = FALSE, quote = F)
write.csv(write_board,  file = f_board_to_be_geocoded_path, row.names = FALSE, quote = F)
write.csv(write_alight, file = f_alight_to_be_geocoded_path, row.names = FALSE, quote = F)

remove(temp_lat, temp_lon, temp_lat_gather, temp_lon_gather, write_places, write_board, write_alight)

```

# _User Intervention 07_
Use the `__/geocode-engine` to geocode the above outcomes so the below expected
files are ready. 

```{r geocode-addit}
# Bring in the geocoding results
geocoded_spatial_places <- read.csv(f_spatial_geocoded_path, header = TRUE)
geocoded_transit_places <- read.csv(f_transit_geocoded_path, header = TRUE)
<<<<<<< HEAD

geocoded_spatial_places <- geocoded_spatial_places %>% 
  rename(unique_ID = Unique_ID) %>%
  select(-x_coord, -y_coord)

geo_spatial_maz <- geocoded_spatial_places %>%
  select(-TAZ1454) %>%
  spread(variable, MAZ_ORIGINAL) %>%
  select(unique_ID, dest_maz = dest, home_maz = home, orig_maz = orig, 
         school_maz = school, workplace_maz = workplace)

=======

geocoded_spatial_places <- geocoded_spatial_places %>% 
  rename(unique_ID = Unique_ID) %>%
  select(-x_coord, -y_coord)

geo_spatial_maz <- geocoded_spatial_places %>%
  select(-TAZ1454) %>%
  spread(variable, MAZ_ORIGINAL) %>%
  select(unique_ID, dest_maz = dest, home_maz = home, orig_maz = orig, 
         school_maz = school, workplace_maz = workplace)

>>>>>>> refactor_survey
geo_spatial_taz <- geocoded_spatial_places %>%
  select(-MAZ_ORIGINAL) %>%
  spread(variable, TAZ1454) %>%
  select(unique_ID, dest_taz = dest, home_taz = home, orig_taz = orig, 
         school_taz = school, workplace_taz = workplace) 

geo_transit_tap <- geocoded_transit_places %>%
  select(unique_ID = Unique_ID, first_board_tap = board_tap, 
         last_alight_tap = alight_tap)

# Joins
survey_standard <- survey_standard %>% 
  left_join(geo_spatial_maz, by = c("unique_ID")) %>%
  left_join(geo_spatial_taz, by = c("unique_ID")) %>%
  left_join(geo_transit_tap, by = c("unique_ID"))

remove(geocoded_spatial_places, 
       geocoded_transit_places, 
       geo_spatial_maz, 
       geo_spatial_taz, 
       geo_transit_tap)
```

### Clean up data types
```{r data-types}
# Cast all factors to numeric or string
survey_standard <- survey_standard %>%
  mutate_at(vars(contains("operator")), as.character) %>%
  mutate_at(vars(contains("hour")), as.numeric) %>%
  mutate(survey_board_lat       = as.numeric(survey_board_lat)) %>%
  mutate(survey_board_lon       = as.numeric(survey_board_lon)) %>%
  mutate(survey_alight_lat      = as.numeric(survey_alight_lat)) %>%
  mutate(survey_alight_lon      = as.numeric(survey_alight_lon)) %>%
  mutate(first_board_lat        = as.numeric(first_board_lat)) %>%
  mutate(first_board_lon        = as.numeric(first_board_lon)) %>%
  mutate(last_alight_lat        = as.numeric(last_alight_lat)) %>%
  mutate(last_alight_lon        = as.numeric(last_alight_lon)) %>%
  mutate(weight                 = as.numeric(weight))

# Create an ancillary data set for requested variables
ancillary_df <- survey_standard %>%
  select(unique_ID, 
         at_school_after_dest_purp, 
         at_school_prior_to_orig_purp, 
         at_work_after_dest_purp, 
         at_work_prior_to_orig_purp)

# Create an ancillary data set for decomposition analysis
survey_decomposition <- survey_standard %>%
  mutate(weight = ifelse(is.na(weight), 0.0, weight)) %>%
  mutate(trip_weight = ifelse(boardings > 0, weight / boardings, weight))%>%
  select(unique_ID,
         access_mode,
         dest_purp,
         direction,
         egress_mode,
         first_route_after_survey_alight,
         first_route_before_survey_board,
         number_transfers_alight_dest,
         number_transfers_orig_board,
         onoff_enter_station,
         onoff_exit_station,
         orig_purp,
         route,
         second_route_after_survey_alight,
         second_route_before_survey_board,
         survey_alight_lat,
         survey_alight_lon,
         survey_board_lat,
         survey_board_lon,
         survey_type,
         third_route_after_survey_alight,
         third_route_before_survey_board,
         weekpart,
         weight,
         ID,
         operator,
         survey_year,
         survey_tech,
         first_before_operator,
         second_before_operator,
         third_before_operator,
         first_after_operator,
         second_after_operator,
         third_after_operator,
         first_before_technology,
         second_before_technology,
         third_before_technology,
         first_after_technology,
         second_after_technology,
         third_after_technology,
         transfer_from,
         transfer_to,
         first_board_tech,
         last_alight_tech,
         path_access,
         path_egress,
         path_line_haul,
         path_label,
         boardings,
         day_of_the_week,
         field_start,
         field_end,
         day_part,
         trip_weight)

saveRDS(survey_decomposition, file = f_output_decom_rdata_path)
write.csv(survey_decomposition, file = f_output_decom_csv_path,  row.names = FALSE)

# Drop variables we don't want to carry forward to standard dataset
survey_standard <- survey_standard %>%
  select(-at_school_after_dest_purp, 
         -at_school_prior_to_orig_purp, 
         -at_work_after_dest_purp, 
         -at_work_prior_to_orig_purp,
         -date,
         -time_start,
         -vehicle_numeric_cat,
         -worker_numeric_cat,
         -year_born,
         -number_transfers_alight_dest,
         -number_transfers_orig_board,
         -first_route_before_survey_board,
         -first_route_after_survey_alight,
         -second_route_before_survey_board,
         -second_route_after_survey_alight,
         -third_route_before_survey_board,
         -third_route_after_survey_alight,
         -first_before_operator,
         -second_before_operator,
         -third_before_operator,
         -first_after_operator,
         -second_after_operator,
         -third_after_operator,
         -first_before_technology,
         -second_before_technology,
         -third_before_technology,
         -first_after_technology,
         -second_after_technology,
         -third_after_technology)

# Drop lat/lon for locations
survey_standard <- survey_standard %>%
  select(-dest_lat,
         -dest_lon,
         -home_lat,
         -home_lon,
         -orig_lat,
         -orig_lon,
         -school_lat,
         -school_lon,
         -workplace_lat,
         -workplace_lon)

```

## Write RDS to Disk
```{r disk-write}
# Compute trip weight, replace missing weights with zero, and set field language to interview language
survey_standard <- survey_standard %>%
  mutate(weight = ifelse(is.na(weight), 0.0, weight)) %>%
  mutate(trip_weight = ifelse(boardings > 0, weight / boardings, weight)) %>%
  mutate(field_language = interview_language)

# put new column, survey_time, at the end
survey_standard_cols <- survey_standard %>% 
  select(-survey_time) %>% 
  colnames()
survey_standard <- survey_standard %>%
  select(survey_standard_cols, survey_time)

saveRDS(survey_standard, file = f_output_rdata_path)
saveRDS(ancillary_df, file = f_ancillary_output_rdata_path)

write.csv(survey_standard, file = f_output_csv_path, row.names = FALSE)
write.csv(ancillary_df, file = f_ancillary_output_csv_path, row.names = FALSE)

```

# DEBUG
```{r debug}
# variables_MUN
# colnames(survey_MUN)
# 
# for(variable in variables_MUN){
#   if(variable %in% colnames(survey_MUN)){
#     print(variable)
#   }
#   else{
#     print(paste('donkey!!!',variable, sep = "--------------!!!---------------"))
#   }
# }
# 
# for(variable in colnames(survey_MUN_melt)){
#   if(!(variable %in% colnames(survey_NAP_melt))){
#     print(variable)
#   }
# }

```
